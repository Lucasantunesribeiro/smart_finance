name: Deploy SmartFinance to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: smartfinance

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          microservice/package-lock.json

    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ” Validate Docker Compose Configuration
      run: |
        echo "ğŸ” Validating production Docker Compose configuration..."
        if [ ! -f "docker-compose.prod.yml" ]; then
          echo "âŒ docker-compose.prod.yml not found!"
          exit 1
        fi
        
        # Validate Docker Compose syntax
        docker-compose -f docker-compose.prod.yml config > /dev/null
        echo "âœ… Docker Compose configuration is valid"

    - name: ğŸ—ï¸ Build and Test Frontend
      run: |
        echo "ğŸ—ï¸ Building and testing frontend..."
        cd frontend
        npm ci
        npm run build
        npm run lint
        echo "âœ… Frontend build completed"

    - name: ğŸ—ï¸ Build and Test Backend
      run: |
        echo "ğŸ—ï¸ Building and testing backend..."
        cd backend
        dotnet restore
        dotnet build --configuration Release --no-restore
        dotnet test --configuration Release --no-build --verbosity normal
        echo "âœ… Backend build completed"

    - name: ğŸ—ï¸ Build and Test Payment Service
      run: |
        echo "ğŸ—ï¸ Building and testing payment service..."
        cd microservice
        npm ci
        npm run build
        npm run lint
        npm run test
        echo "âœ… Payment service build completed"

    - name: ğŸ” Configure SSH
      run: |
        echo "ğŸ” Setting up SSH configuration..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        echo "âœ… SSH configuration completed"
      env:
        EC2_SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        EC2_HOST: ${{ secrets.EC2_HOST }}

    - name: ğŸš€ Deploy to EC2
      run: |
        echo "ğŸš€ Starting deployment to EC2..."
        
        # Create deployment package
        echo "ğŸ“¦ Creating deployment package..."
        tar --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='bin' \
            --exclude='obj' \
            --exclude='*.log' \
            --exclude='.backup' \
            -czf smartfinance-deploy.tar.gz .
        
        # Copy deployment package to EC2
        echo "ğŸ“¤ Uploading deployment package..."
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            smartfinance-deploy.tar.gz \
            ubuntu@${{ secrets.EC2_HOST }}:/tmp/
        
        # Execute deployment on EC2
        echo "ğŸ”§ Executing deployment on EC2..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ Starting deployment on EC2 instance..."
          
          # Navigate to application directory
          cd /opt/smartfinance
          
          # Backup current deployment
          if [ -d "current" ]; then
            echo "ğŸ’¾ Creating backup of current deployment..."
            sudo rm -rf backup || true
            sudo mv current backup || true
          fi
          
          # Extract new deployment
          echo "ğŸ“¦ Extracting new deployment..."
          sudo mkdir -p current
          cd current
          sudo tar -xzf /tmp/smartfinance-deploy.tar.gz
          sudo chown -R ubuntu:ubuntu .
          
          # Setup environment variables
          echo "âš™ï¸ Setting up environment variables..."
          if [ ! -f ".env.production" ]; then
            echo "ğŸ”§ Creating production environment file..."
            cat > .env.production << 'ENVEOF'
NODE_ENV=production
ASPNETCORE_ENVIRONMENT=Production
SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}
MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
JWT_ISSUER=SmartFinance
JWT_AUDIENCE=SmartFinanceUsers
NEXT_PUBLIC_API_URL=/api/v1
NEXT_PUBLIC_SIGNALR_URL=/financehub
NEXT_PUBLIC_PAYMENT_SERVICE_URL=/payment
ConnectionStrings__DefaultConnection=Data Source=smartfinance.db
GF_SECURITY_ADMIN_PASSWORD=${{ secrets.GRAFANA_PASSWORD }}
ENVEOF
          fi
          
          # Load environment variables
          export $(cat .env.production | grep -v '^#' | xargs)
          
          # Stop existing services gracefully
          echo "ğŸ›‘ Stopping existing services..."
          docker-compose -f docker-compose.prod.yml down --timeout 30 || true
          
          # Clean up Docker resources
          echo "ğŸ§¹ Cleaning up Docker resources..."
          docker system prune -f || true
          
          # Build and start services
          echo "ğŸ”¨ Building and starting services..."
          docker-compose -f docker-compose.prod.yml up -d --build
          
          # Wait for services to start
          echo "â³ Waiting for services to initialize..."
          sleep 45
          
          # Health check with retries
          echo "ğŸ¥ Performing health checks..."
          max_retries=12
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if curl -f -s http://localhost/health > /dev/null; then
              echo "âœ… Application is healthy!"
              break
            else
              retry_count=$((retry_count + 1))
              echo "â³ Health check attempt $retry_count/$max_retries failed, retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ Health check failed after $max_retries attempts"
            echo "ğŸ“Š Service status:"
            docker-compose -f docker-compose.prod.yml ps
            echo "ğŸ“ Service logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=50
            exit 1
          fi
          
          # Final status check
          echo "ğŸ“Š Final deployment status:"
          docker-compose -f docker-compose.prod.yml ps
          
          # Clean up deployment package
          rm -f /tmp/smartfinance-deploy.tar.gz
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Application is available at: http://${{ secrets.EC2_HOST }}"
        EOF

    - name: ğŸ§ª Post-Deployment Testing
      run: |
        echo "ğŸ§ª Running post-deployment tests..."
        
        # Wait a bit more for services to fully stabilize
        sleep 30
        
        # Test main application endpoint
        echo "ğŸ” Testing main application..."
        if curl -f -s "http://${{ secrets.EC2_HOST }}/health"; then
          echo "âœ… Main application health check passed"
        else
          echo "âŒ Main application health check failed"
          exit 1
        fi
        
        # Test API endpoint
        echo "ğŸ” Testing API endpoint..."
        if curl -f -s "http://${{ secrets.EC2_HOST }}/api/v1/health"; then
          echo "âœ… API health check passed"
        else
          echo "âŒ API health check failed"
          exit 1
        fi
        
        # Test payment service endpoint
        echo "ğŸ” Testing payment service..."
        if curl -f -s "http://${{ secrets.EC2_HOST }}/payment/health"; then
          echo "âœ… Payment service health check passed"
        else
          echo "âŒ Payment service health check failed"
          exit 1
        fi
        
        echo "ğŸ‰ All post-deployment tests passed!"

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "ğŸ¯ Target: ${{ secrets.EC2_HOST }}"
        echo "ğŸŒ Application URL: http://${{ secrets.EC2_HOST }}"
        echo "ğŸ“… Deployed at: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment Status: SUCCESS"
        else
          echo "âŒ Deployment Status: FAILED"
        fi

    - name: ğŸš¨ Rollback on Failure
      if: failure()
      run: |
        echo "ğŸš¨ Deployment failed, attempting rollback..."
        
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
          cd /opt/smartfinance
          
          if [ -d "backup" ]; then
            echo "ğŸ”„ Rolling back to previous version..."
            sudo rm -rf current || true
            sudo mv backup current || true
            cd current
            
            # Restart services with backup version
            docker-compose -f docker-compose.prod.yml down || true
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "âœ… Rollback completed"
          else
            echo "âŒ No backup found for rollback"
          fi
        EOF